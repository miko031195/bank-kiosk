<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Kredit Ã¶dÉ™niÅŸi</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root{ --brand:#155EEF; --ink:#0f172a; --muted:#64748b; --bg:#f1f5f9; --card:#ffffff; --radius:22px; --shadow:0 18px 50px rgba(2,8,23,.15); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1200px;margin:24px auto;padding:20px}
    .top{display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand .dot{width:24px;height:24px;border-radius:999px;background:var(--brand)}
    .grow{flex:1}
    .help{font-size:14px;color:var(--muted)}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid #e2e8f0}
    .stage{display:grid;grid-template-columns:1.1fr 2fr;gap:18px}
    .left{padding:22px;border-right:1px solid #e2e8f0}
    .right{padding:22px}

    .step{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .step .num{width:34px;height:34px;border-radius:12px;background:#eff6ff;color:#1d4ed8;font-weight:800;display:grid;place-items:center}
    .step .title{font-weight:800}

    .form{display:grid;gap:14px}
    .input{width:100%;padding:16px 16px;border-radius:14px;border:1px solid #cbd5e1;font-size:18px}
    .row{display:flex;gap:12px}
    .row>.input{flex:1}

    .btn{min-height:60px;padding:16px 20px;border-radius:16px;border:1px solid #cbd5e1;background:#fff;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:#f8fafc}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:0.5;cursor:not-allowed}

    .table{width:100%;border-collapse:separate;border-spacing:0 10px}
    .table th{font-size:14px;color:var(--muted);text-align:left;padding:0 12px}
    .table td{background:#fff;border:1px solid #e2e8f0;padding:14px 12px}
    .table tr td:first-child{border-radius:12px 0 0 12px}
    .table tr td:last-child{border-radius:0 12px 12px 0}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted)}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi .box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:14px;padding:12px}
    .box h4{margin:0 0 6px;font-size:14px;color:#334155}
    .box .v{font-weight:800;font-size:20px}

    .footer{margin-top:16px;display:flex;justify-content:space-between;align-items:center}

    .skeleton{background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:s 1.2s linear infinite;border-radius:12px}
    @keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}

    .numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .key{padding:18px 0;border:1px solid #cbd5e1;border-radius:14px;background:#fff;font-weight:800;font-size:22px;cursor:pointer}
    .key:active{transform:scale(0.95)}

    .status{padding:12px;border-radius:12px;margin:10px 0;font-weight:600}
    .status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .status.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}

    /* BÃ¶yÃ¼k tÉ™qvim Ã¼Ã§Ã¼n stil */
    .flatpickr-current-month .cur-year,
    .flatpickr-current-month .numInput.cur-year {
      font-size: 28px;
      font-weight: 700;
      line-height: 40px;
      height: 40px;
      width: 90px;
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months {
      font-size: 22px;
      height: 40px;
      padding: 4px 8px;
    }
    .flatpickr-months .flatpickr-month {
      height: 64px;
    }
    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
      width: 44px;
      height: 44px;
      transform: scale(1.25);
    }
    .numInput.cur-year,
    input.cur-year {
      font-size: 28px !important;
      font-weight: 700 !important;
    }

    @media (max-width:1100px){ 
      .stage{grid-template-columns:1fr} 
      .left{border-right:none;border-bottom:1px solid #e2e8f0} 
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><div class="dot"></div> <span>Kredit Ã¶dÉ™niÅŸi</span></div>
      <div class="grow"></div>
      <div class="help">ID/FIN + DoÄŸum tarixi â†’ kredit seÃ§ â†’ mÉ™blÉ™ÄŸ â†’ Ã¶dÉ™niÅŸ</div>
    </div>

    <div class="card stage" id="stage">
      <div class="left">
        <div class="step"><div class="num">1</div><div class="title">MÃ¼ÅŸtÉ™ri identifikasiyasÄ±</div></div>
        <form class="form" id="formId">
          <input class="input" id="custId" placeholder="MÃ¼ÅŸtÉ™ri ID-si vÉ™ ya FIN kod" autocomplete="off" />
          <div class="row">
            <input class="input" id="dob" type="date" placeholder="DoÄŸum tarixi" />
            <button type="submit" class="btn primary" id="btnLookup">Axtar</button>
          </div>
          <div class="muted">* Æn azÄ± bir ID/FIN + doÄŸum tarixi tÉ™lÉ™b olunur</div>
        </form>

        <hr style="margin:18px 0;border:none;border-top:1px dashed #e2e8f0"/>

        <div class="step"><div class="num">2</div><div class="title">Kredit seÃ§imi</div></div>
        <div id="custSummary" class="muted">MÃ¼ÅŸtÉ™ri tapÄ±lmadÄ±. MÉ™lumatlarÄ± daxil edin vÉ™ "Axtar".</div>
        <div id="creditsWrap" style="display:none">
          <div class="kpi">
            <div class="box"><h4>Ad, Soyad</h4><div class="v" id="fullName">â€”</div></div>
            <div class="box"><h4>KreditlÉ™rin sayÄ±</h4><div class="v" id="kCount">0</div></div>
          </div>
          <div style="margin:12px 0 6px" class="muted">KreditlÉ™r</div>
          <table class="table" id="tblCredits">
            <thead>
              <tr><th></th><th>MÃ¼qavilÉ™</th><th>Bank</th><th>QalÄ±q (â‚¼)</th><th>GecikmÉ™</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <hr style="margin:18px 0;border:none;border-top:1px dashed #e2e8f0"/>

        <div class="step"><div class="num">3</div><div class="title">Ã–dÉ™niÅŸ</div></div>
        <form class="form" id="formPay" style="display:none">
          <div class="grid2">
            <input class="input" id="amount" type="number" min="1" step="0.01" placeholder="MÉ™blÉ™ÄŸ (â‚¼)" required />
            <input class="input" id="note" placeholder="Qeyd (istÉ™yÉ™ baÄŸlÄ±)" />
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button type="button" class="btn" id="btnPayAll">Tam borcu Ã¶dÉ™</button>
            <button type="button" class="btn" id="btn5">+5 â‚¼</button>
            <button type="button" class="btn" id="btn10">+10 â‚¼</button>
            <button type="button" class="btn" id="btn50">+50 â‚¼</button>
          </div>
          <div style="margin-top:8px" class="numpad" id="numpad">
            <button type="button" class="key">1</button>
            <button type="button" class="key">2</button>
            <button type="button" class="key">3</button>
            <button type="button" class="key">4</button>
            <button type="button" class="key">5</button>
            <button type="button" class="key">6</button>
            <button type="button" class="key">7</button>
            <button type="button" class="key">8</button>
            <button type="button" class="key">9</button>
            <button type="button" class="key">00</button>
            <button type="button" class="key">0</button>
            <button type="button" class="key" data-del>âŒ«</button>
          </div>
          <div id="paymentStatus"></div>
          <div class="row">
            <button type="button" class="btn ghost" id="btnBack">â† Geri</button>
            <button type="submit" class="btn primary" id="btnPay">Ã–dÉ™niÅŸi tÉ™sdiqlÉ™</button>
          </div>
        </form>
      </div>

      <div class="right">
        <div class="step"><div class="num">4</div><div class="title">MÉ™lumat xÃ¼lasÉ™si</div></div>
        <div class="kpi">
          <div class="box"><h4>SeÃ§ilÉ™n kredit</h4><div class="v" id="selContract">â€”</div></div>
          <div class="box"><h4>Ã–dÉ™nilmÉ™li mÉ™blÉ™ÄŸ</h4><div class="v" id="due">â€”</div></div>
          <div class="box"><h4>Ad, Soyad</h4><div class="v" id="namePreview">â€”</div></div>
          <div class="box"><h4>Bank</h4><div class="v" id="bankName">â€”</div></div>
        </div>

        <div style="margin-top:16px" class="muted">Qeyd: NaÄŸd Ã¶dÉ™niÅŸ avadanlÄ±ÄŸÄ± vÉ™ real printer ilÉ™ inteqrasiya.</div>
      </div>
    </div>

    <div class="footer">
      <button class="btn" onclick="history.back()">â† Geri (Ana sÉ™hifÉ™)</button>
      <div class="muted">Terminal â„– 2312 â€¢ DÉ™stÉ™k: 8 800 250 57 57</div>
    </div>
  </div>

  <script>
    // ============================================
    // KONFIQURASIYA
    // ============================================
    const PRINTER_BASE_URL = "http://10.66.66.63:8080";
    const HARDWARE_BASE_URL = "http://10.66.66.63:8080";
    const PRINTER_ID = 1;

    // ============================================
    // DEBUG FUNKSIYASI
    // ============================================
    function addDebug(message) {
      const timestamp = new Date().toLocaleTimeString('az-AZ');
      console.log(`[${timestamp}] ${message}`);
    }

    // ============================================
    // DEMO VERILÆNLÆR BAZASI
    // ============================================
    const MOCK_DB = {
      "A12345|8Q9ABCD|1990-05-20": { 
        fullName: "RÉ™ÅŸad Quliyev", 
        credits: [
          { contract: "CR-2021-001", bank: "HALAL-P Bank", due: 258.40, overdue: "0 gÃ¼n" },
          { contract: "CR-2022-145", bank: "HALAL-P Bank", due: 1320.00, overdue: "5 gÃ¼n" }
        ] 
      },
      "98210|3DF7K2L|1987-01-10": { 
        fullName: "KÃ¶nÃ¼l MÉ™mmÉ™dova", 
        credits: [
          { contract: "CR-2019-778", bank: "HALAL-P Bank", due: 75.00, overdue: "0 gÃ¼n" }
        ] 
      }
    };

    // ============================================
    // MÃœÅTÆRÄ° AXTARIÅI
    // ============================================
    function findCustomer(idOrFin, dob) {
      return Object.keys(MOCK_DB)
        .map(k => ({ k, parts: k.split('|') }))
        .find(({ parts }) => (parts[0] === idOrFin || parts[1] === idOrFin) && parts[2] === dob);
    }

    // ============================================
    // PRINTER STATUSU YOXLAMASI
    // ============================================
    async function checkPrinterStatus(printerId = PRINTER_ID) {
      try {
        addDebug('Printer statusu yoxlanÄ±lÄ±r...');
        
        const response = await fetch(`${PRINTER_BASE_URL}/api/getPrintStatus`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: printerId })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        addDebug(`Printer status cavabÄ±: ${JSON.stringify(result)}`);
        
        if (result.isSuccess && result.data === "Printer Normal") {
          addDebug('âœ“ Printer hazÄ±rdÄ±r');
          return { success: true };
        }
        
        return { success: false, message: result.errorMsg || "Printer problemi" };
      } catch (error) {
        addDebug(`âœ— Printer status xÉ™tasÄ±: ${error.message}`);
        return { success: false, message: error.message };
      }
    }

    // ============================================
    // QÆBZ Ã‡AP FUNKSIYASI (Ä°STEHSALÃ‡I FORMATI)
    // ============================================
    async function printReceipt(receiptData, printerId = PRINTER_ID) {
      try {
        addDebug("Ã‡ek Ã§ap edilir...");

        const currentDate = new Date();
        const dateStr = currentDate.toLocaleDateString('az-AZ');
        const timeStr = currentDate.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });

        const templateContent = buildTemplateReceipt(receiptData, dateStr, timeStr);

        const templateAttempt = await sendPrinterPayload({
          id: Number(printerId),
          type: "template",
          encoding: "UTF-8",
          data: templateContent
        }, 'template');

        if (templateAttempt.success) {
          return { success: true };
        }

        if (shouldFallbackToPlainText(templateAttempt)) {
          addDebug('Template formatÄ± qÉ™bul edilmÉ™di, adi mÉ™tn formatÄ±na keÃ§ilir...');

          const plainContent = buildPlainReceipt(receiptData, dateStr, timeStr);
          const plainAttempt = await sendPrinterPayload({
            id: Number(printerId),
            type: "string",
            data: plainContent
          }, 'string');

          if (plainAttempt.success) {
            await sendPrinterPayload({
              id: Number(printerId),
              type: "cut",
              data: "half"
            }, 'cut');

            return { success: true };
          }

          const plainMessage = plainAttempt.message || plainAttempt.error || 'Ã‡ek Ã§ap edilmÉ™di';
          return { success: false, error: plainMessage };
        }

        const message = templateAttempt.message || templateAttempt.error || 'Ã‡ek Ã§ap edilmÉ™di';
        return { success: false, error: message };
      } catch (error) {
        addDebug(`Ã‡ek Ã§ap xÉ™tasÄ±: ${error.message}`);
        return { success: false, error: error.message };
      }
    }

    function normalizeToTurkishCharset(text) {
      if (typeof text !== 'string' || !text) {
        return text;
      }

      const map = {
        'É™': 'e',
        'Æ': 'E',
        'Ã¤': 'a',
        'Ã„': 'A',
        'Ã¶': 'Ã¶',
        'Ã–': 'Ã–',
        'Ã¼': 'Ã¼',
        'Ãœ': 'Ãœ',
        'Ä±': 'Ä±',
        'Ä°': 'Ä°',
        'ÄŸ': 'ÄŸ',
        'Ä': 'Ä',
        'ÅŸ': 'ÅŸ',
        'Å': 'Å',
        'Ã§': 'Ã§',
        'Ã‡': 'Ã‡'
      };

      return text.replace(/[ÆÉ™Ã„Ã¤Ã–Ã¶ÃœÃ¼Ä°Ä±ÄÄŸÅÅŸÃ‡Ã§]/g, ch => map[ch] || ch);
    }

    function buildTemplateReceipt(receiptData, dateStr, timeStr) {
      let content = "";
      content += "#cmd_fs_l\n#cmd_ta_c\nHALAL-P BANK\n";
      content += "#cmd_fs_m\n#cmd_ta_c\nKredit Ã–dÉ™niÅŸ QÉ™bzi\nNardaran filialÄ±\n";
      content += "#cmd_sep_equal\n";
      content += "#cmd_ta_l\n#cmd_fs_s\n";
      content += `Tarix: ${dateStr}\n`;
      content += `Saat: ${timeStr}\n`;
      content += "#cmd_sep_hyphen\n";
      content += "#cmd_fs_m\n#cmd_ta_l\nMÃœÅTÆRÄ°:\n";
      content += "#cmd_fs_s\n";
      content += `Ad: ${receiptData.customer}\n`;
      content += `MÃ¼qavilÉ™: ${receiptData.contract}\n`;
      content += `Bank: ${receiptData.bank}\n`;
      content += "#cmd_sep_hyphen\n";
      content += "#cmd_fs_m\n#cmd_ta_l\nÃ–DÆNÄ°Å:\n";
      content += "#cmd_fs_s\n";
      content += `MÉ™blÉ™ÄŸ: ${receiptData.paid.toFixed(2)} AZN\n`;
      content += "NÃ¶v: NaÄŸd\n";

      if (receiptData.note && receiptData.note.trim()) {
        content += `Qeyd: ${receiptData.note}\n`;
      }

      if (receiptData.transaction_id) {
        const shortTxId = receiptData.transaction_id.substring(0, 18);
        content += `Tranzaksiya ID: ${shortTxId}\n`;
      }

      content += "#cmd_sep_equal\n";
      content += "#cmd_fs_s\n#cmd_ta_c\n";
      content += "Terminal â„– 2312 â€¢ Nardaran\n";
      content += "TÉ™ÅŸÉ™kkÃ¼r edirik!\n";
      content += "#cmd_lf_2\n";
      content += "#cmd_cut_\n";

      return normalizeToTurkishCharset(content);
    }

    function buildPlainReceipt(receiptData, dateStr, timeStr) {
      const lines = [];
      lines.push('HALAL-P BANK');
      lines.push('Kredit Ã–dÉ™niÅŸ QÉ™bzi');
      lines.push('==============================');
      lines.push(`Tarix: ${dateStr}`);
      lines.push(`Saat: ${timeStr}`);
      lines.push('------------------------------');
      lines.push(`MÃ¼ÅŸtÉ™ri: ${receiptData.customer}`);
      lines.push(`MÃ¼qavilÉ™: ${receiptData.contract}`);
      lines.push(`Bank: ${receiptData.bank}`);
      lines.push('------------------------------');
      lines.push(`Ã–dÉ™nilÉ™n mÉ™blÉ™ÄŸ: ${receiptData.paid.toFixed(2)} AZN`);
      lines.push('Ã–dÉ™niÅŸ nÃ¶vÃ¼: NaÄŸd');

      if (receiptData.note && receiptData.note.trim()) {
        lines.push(`Qeyd: ${receiptData.note.trim()}`);
      }

      if (receiptData.transaction_id) {
        lines.push(`Tranzaksiya ID: ${receiptData.transaction_id.substring(0, 18)}`);
      }

      lines.push('==============================');
      lines.push('Terminal â„– 2312 â€¢ Nardaran');
      lines.push('TÉ™ÅŸÉ™kkÃ¼r edirik!');

      return normalizeToTurkishCharset(lines.join('\n'));
    }

    async function sendPrinterPayload(payload, label) {
      try {
        const shortPreview = typeof payload.data === 'string'
          ? `${payload.data.substring(0, 80)}${payload.data.length > 80 ? 'â€¦' : ''}`
          : '';
        addDebug(`PrinterÉ™ ${label} sorÄŸusu gÃ¶ndÉ™rilir (${JSON.stringify({ ...payload, data: undefined })}) :: ${shortPreview}`);

        const response = await fetch(`${PRINTER_BASE_URL}/api/printSetting`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const raw = await response.text();
        const trimmed = raw ? raw.trim() : '';
        let parsed = null;

        if (trimmed) {
          try {
            parsed = JSON.parse(trimmed);
          } catch (parseError) {
            addDebug(`Printer ${label} cavabÄ± JSON deyil: ${trimmed}`);
          }
        }

        if (detectPrinterSuccess(parsed, trimmed)) {
          addDebug(`Printer ${label} cavabÄ± uÄŸurludur${trimmed ? `: ${trimmed}` : ' (boÅŸ cavab)'}`);
          return { success: true, parsed, raw: trimmed };
        }

        const message = extractPrinterMessage(parsed, trimmed) || `Printer ${label} cavabÄ± uÄŸursuz oldu`;
        addDebug(`Printer ${label} uÄŸursuz: ${message}`);
        return { success: false, parsed, raw: trimmed, message };
      } catch (error) {
        addDebug(`Printer ${label} xÉ™tasÄ±: ${error.message}`);
        return { success: false, error: error.message };
      }
    }

    function detectPrinterSuccess(parsed, rawText) {
      if (parsed) {
        if (parsed.isSuccess === true || parsed.success === true) {
          return true;
        }

        if (parsed.isSuccess === false || parsed.success === false) {
          return false;
        }

        if (typeof parsed.status === 'string' && /success|printed|ok/i.test(parsed.status)) {
          return true;
        }

        if (typeof parsed.data === 'string' && /success|printed|ok/i.test(parsed.data)) {
          return true;
        }

        if (parsed.errorCode === 200 && parsed.errorMsg == null) {
          return true;
        }
      }

      if (!rawText) {
        return true;
      }

      return /success|printed|ok/i.test(rawText);
    }

    function extractPrinterMessage(parsed, rawText) {
      if (parsed) {
        if (typeof parsed.errorMsg === 'string' && parsed.errorMsg.trim()) {
          return parsed.errorMsg.trim();
        }

        if (typeof parsed.message === 'string' && parsed.message.trim()) {
          return parsed.message.trim();
        }

        if (typeof parsed.data === 'string' && parsed.data.trim() && !/success|printed|ok/i.test(parsed.data)) {
          return parsed.data.trim();
        }
      }

      if (rawText) {
        return rawText;
      }

      return null;
    }

    function shouldFallbackToPlainText(result) {
      if (!result || result.success) {
        return false;
      }

      if (result.parsed && result.parsed.errorCode === 501) {
        return true;
      }

      const messages = [
        result.message,
        result.error,
        result.raw,
        result.parsed && typeof result.parsed.errorMsg === 'string' ? result.parsed.errorMsg : null,
        result.parsed && typeof result.parsed.message === 'string' ? result.parsed.message : null,
        result.parsed && typeof result.parsed.data === 'string' ? result.parsed.data : null
      ].filter(Boolean).join(' ').toLowerCase();

      if (!messages) {
        return false;
      }

      return messages.includes('invalid format') ||
        messages.includes('param format') ||
        messages.includes('template not support') ||
        messages.includes('template not supported');
    }

    // ============================================
    // NAÄD Ã–DÆNÄ°Å PROSESÄ°
    // ============================================
    async function processPayment(amount) {
      const statusDiv = document.getElementById('paymentStatus');
      const btnPay = document.getElementById('btnPay');
      
      try {
        btnPay.disabled = true;
        statusDiv.innerHTML = '<div class="status info">â³ Ã–dÉ™niÅŸ avadanlÄ±ÄŸÄ± ilÉ™ É™laqÉ™ qurulur...</div>';
        
        addDebug(`Ã–dÉ™niÅŸ baÅŸladÄ±: ${amount.toFixed(2)} AZN`);
        
        // Hardware API-yÉ™ Ã¶dÉ™niÅŸ sorÄŸusu
        const paymentResp = await fetch(`${HARDWARE_BASE_URL}/api/payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount: amount.toFixed(2) })
        });
        
        if (!paymentResp.ok) {
          throw new Error(`Hardware API xÉ™tasÄ±: ${paymentResp.status}`);
        }
        
        const respData = await paymentResp.json();
        addDebug(`Hardware cavab: ${JSON.stringify(respData)}`);
        
        // UUID/Transaction ID É™ldÉ™ et
        let uuid = respData.data?.uuid || respData.uuid || respData.transaction_id;
        if (!uuid) {
          throw new Error("UUID/Transaction ID alÄ±nmadÄ±");
        }
        
        addDebug(`Transaction UUID: ${uuid}`);
        statusDiv.innerHTML = `<div class="status info">ğŸ’µ ZÉ™hmÉ™t olmasa ${amount.toFixed(2)} AZN naÄŸd daxil edin...</div>`;
        
        // Status yoxlanÄ±ÅŸÄ± (polling)
        return new Promise((resolve, reject) => {
          let checkCount = 0;
          const maxChecks = 300; // 5 dÉ™qiqÉ™ (300 saniyÉ™)
          
          const interval = setInterval(async () => {
            checkCount++;
            
            if (checkCount > maxChecks) {
              clearInterval(interval);
              reject(new Error("Ã–dÉ™niÅŸ vaxtÄ± bitdi (5 dÉ™qiqÉ™)"));
              return;
            }
            
            try {
              const stResp = await fetch(`${HARDWARE_BASE_URL}/api/query`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ uuid })
              });
              
              if (!stResp.ok) {
                throw new Error(`Status API xÉ™tasÄ±: ${stResp.status}`);
              }
              
              const stData = await stResp.json();
              const st = stData.data || stData;
              
              let status = st.info?.status || st.status || "unknown";
              let paidAmount = Number(st.info?.pay_amount || st.paid || 0);
              
              addDebug(`Status yoxlanÄ±ÅŸÄ± #${checkCount}: ${status}, Ã–dÉ™nilÉ™n: ${paidAmount}`);
              
              // Ã–dÉ™niÅŸ tamamlandÄ±
              if (status === "completed" || status === "payment is completed") {
                if (paidAmount >= amount) {
                  clearInterval(interval);
                  addDebug(`âœ“ Ã–dÉ™niÅŸ tamamlandÄ±: ${paidAmount.toFixed(2)} AZN`);
                  resolve({ success: true, uuid: uuid, paid: paidAmount });
                } else {
                  statusDiv.innerHTML = `<div class="status error">âš  KifayÉ™t etmir! Ã–dÉ™nilÉ™n: ${paidAmount.toFixed(2)} AZN / LazÄ±m: ${amount.toFixed(2)} AZN</div>`;
                }
              } 
              // XÉ™ta statuslarÄ±
              else if (["error", "jam", "full", "reject", "cancelled", "timeout"].includes(status)) {
                clearInterval(interval);
                addDebug(`âœ— AvadanlÄ±q xÉ™tasÄ±: ${status}`);
                reject(new Error(`AvadanlÄ±q xÉ™tasÄ±: ${status}`));
              } 
              // GÃ¶zlÉ™mÉ™ statuslarÄ±
              else if (["waiting", "pending", "accepting", "paying", "processing"].includes(status)) {
                if (paidAmount > 0) {
                  const remaining = amount - paidAmount;
                  statusDiv.innerHTML = `<div class="status info">ğŸ’° Daxil edildi: ${paidAmount.toFixed(2)} AZN<br>ğŸ“Š Qalan: ${remaining.toFixed(2)} AZN</div>`;
                } else {
                  statusDiv.innerHTML = `<div class="status info">â³ Pul gÃ¶zlÉ™nilir... LazÄ±m olan mÉ™blÉ™ÄŸ: ${amount.toFixed(2)} AZN</div>`;
                }
              }
            } catch (e) {
              addDebug(`âš  Status yoxlanÄ±ÅŸ xÉ™tasÄ±: ${e.message}`);
            }
          }, 1000); // HÉ™r saniyÉ™ yoxla
        });
        
      } catch (error) {
        addDebug(`âœ— Ã–dÉ™niÅŸ xÉ™tasÄ±: ${error.message}`);
        statusDiv.innerHTML = `<div class="status error">âœ— XÉ™ta: ${error.message}</div>`;
        btnPay.disabled = false;
        throw error;
      }
    }

    // ============================================
    // GLOBAL STATE
    // ============================================
    let CURRENT = { customer: null, selected: null };

    // ============================================
    // DOM ELEMENTLÆRI
    // ============================================
    const el = (id) => document.getElementById(id);
    const formId = el('formId');
    const formPay = el('formPay');

    // ============================================
    // 1. MÃœÅTÆRÄ° AXTARIÅI
    // ============================================
    formId.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = el('custId').value.trim();
      const dob = el('dob').value;
      
      if (!id || !dob) {
        alert('âš  ZÉ™hmÉ™t olmasa ID/FIN vÉ™ doÄŸum tarixini daxil edin');
        return;
      }

      addDebug(`MÃ¼ÅŸtÉ™ri axtarÄ±lÄ±r: ID=${id}, DOB=${dob}`);
      
      el('custSummary').innerHTML = '<div class="skeleton" style="height:20px;width:60%"></div>';
      await new Promise(r => setTimeout(r, 600)); // Simulyasiya

      const found = findCustomer(id, dob);
      
      if (!found) {
        addDebug('âœ— MÃ¼ÅŸtÉ™ri tapÄ±lmadÄ±');
        el('custSummary').textContent = 'âœ— MÃ¼ÅŸtÉ™ri tapÄ±lmadÄ±. MÉ™lumatlarÄ± yenidÉ™n yoxlayÄ±n.';
        el('creditsWrap').style.display = 'none';
        formPay.style.display = 'none';
        CURRENT = { customer: null, selected: null };
        updateSummary();
        return;
      }
      
      const data = MOCK_DB[found.k];
      CURRENT.customer = data;
      
      addDebug(`âœ“ MÃ¼ÅŸtÉ™ri tapÄ±ldÄ±: ${data.fullName}, ${data.credits.length} kredit`);
      
      el('custSummary').textContent = '';
      el('creditsWrap').style.display = 'block';
      el('fullName').textContent = data.fullName;
      el('kCount').textContent = data.credits.length;

      const tbody = el('tblCredits').querySelector('tbody');
      tbody.innerHTML = '';
      
      data.credits.forEach((c, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="radio" name="credit" value="${idx}"></td>
          <td>${c.contract}</td>
          <td>${c.bank}</td>
          <td>${c.due.toFixed(2)}</td>
          <td>${c.overdue}</td>`;
        tbody.appendChild(tr);
      });

      formPay.style.display = 'none';
      CURRENT.selected = null;
      updateSummary();
    });

    // ============================================
    // 2. KREDÄ°T SEÃ‡Ä°MÄ°
    // ============================================
    document.addEventListener('change', (e) => {
      if (e.target && e.target.name === 'credit') {
        const idx = parseInt(e.target.value, 10);
        CURRENT.selected = CURRENT.customer.credits[idx];
        
        addDebug(`Kredit seÃ§ildi: ${CURRENT.selected.contract}`);
        
        formPay.style.display = 'grid';
        el('amount').value = CURRENT.selected.due.toFixed(2);
        el('note').value = '';
        el('paymentStatus').innerHTML = '';
        
        updateSummary();
      }
    });

    // ============================================
    // 3. MÆBLÆÄ DÃœYMÆLÆRI
    // ============================================
    el('btnPayAll').addEventListener('click', () => {
      if (CURRENT.selected) {
        el('amount').value = CURRENT.selected.due.toFixed(2);
        addDebug(`Tam borc: ${CURRENT.selected.due.toFixed(2)} AZN`);
      }
    });

    el('btn5').addEventListener('click', () => bump(5));
    el('btn10').addEventListener('click', () => bump(10));
    el('btn50').addEventListener('click', () => bump(50));

    function bump(x) {
      const v = parseFloat(el('amount').value || 0);
      el('amount').value = (isFinite(v) ? v : 0) + x;
      addDebug(`MÉ™blÉ™ÄŸ artÄ±rÄ±ldÄ± +${x}: ${el('amount').value} AZN`);
    }

    // ============================================
    // 4. NUMPAD (RÆQÆM KLAVÄ°ATURASI)
    // ============================================
    el('numpad').addEventListener('click', (e) => {
      if (!e.target.classList.contains('key')) return;
      
      const amountInput = el('amount');
      
      // Sil dÃ¼ymÉ™si (âŒ«)
      if (e.target.hasAttribute('data-del')) {
        amountInput.value = (amountInput.value + '').slice(0, -1);
        addDebug(`RÉ™qÉ™m silindi: ${amountInput.value}`);
        return;
      }
      
      const key = e.target.textContent.trim();
      
      // 00 dÃ¼ymÉ™si
      if (key === '00') {
        amountInput.value = (amountInput.value || '') + '00';
        addDebug(`00 É™lavÉ™ edildi: ${amountInput.value}`);
        return;
      }
      
      // RÉ™qÉ™m dÃ¼ymÉ™lÉ™ri
      amountInput.value = (amountInput.value || '') + key;
      addDebug(`RÉ™qÉ™m É™lavÉ™ edildi (${key}): ${amountInput.value}`);
    });

    // ============================================
    // 5. Ã–DÆNÄ°Å PROSESÄ°
    // ============================================
    formPay.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!CURRENT.selected) {
        alert('âš  ZÉ™hmÉ™t olmasa kredit seÃ§in');
        return;
      }
      
      const amt = parseFloat(el('amount').value);
      
      if (!Number.isFinite(amt) || amt <= 0) {
        alert('âš  MÉ™blÉ™ÄŸi dÃ¼zgÃ¼n daxil edin (mÉ™sÉ™lÉ™n: 100.50)');
        return;
      }

      const statusDiv = el('paymentStatus');
      const btnPay = el('btnPay');
      
      try {
        addDebug(`=== Ã–DÆNÄ°Å BAÅLADI ===`);
        addDebug(`MÉ™blÉ™ÄŸ: ${amt.toFixed(2)} AZN`);
        addDebug(`MÃ¼qavilÉ™: ${CURRENT.selected.contract}`);
        
        // Ã–dÉ™niÅŸ prosesi
        statusDiv.innerHTML = '<div class="status info">â³ Ã–dÉ™niÅŸ baÅŸladÄ±...</div>';
        const paymentResult = await processPayment(amt);
        
        if (paymentResult.success) {
          statusDiv.innerHTML = '<div class="status success">âœ“ Ã–dÉ™niÅŸ qÉ™bul edildi! QÉ™bz Ã§ap olunur...</div>';
          
          addDebug('âœ“ Ã–dÉ™niÅŸ uÄŸurla tamamlandÄ±');
          addDebug(`UUID: ${paymentResult.uuid}`);
          addDebug(`Ã–dÉ™nilÉ™n: ${paymentResult.paid.toFixed(2)} AZN`);
          
          // QÉ™bz mÉ™lumatlarÄ±
          const receipt = {
            time: new Date().toISOString(),
            customer: CURRENT.customer.fullName,
            contract: CURRENT.selected.contract,
            bank: CURRENT.selected.bank,
            paid: amt,
            note: el('note').value,
            transaction_id: paymentResult.uuid
          };
          
          addDebug('=== QÆBZ Ã‡AP OLUNUR ===');
          
          // QÉ™bz Ã§ap et
          const printResult = await printReceipt(receipt);
          
          if (printResult.success) {
            addDebug('âœ“ QÉ™bz uÄŸurla Ã§ap olundu');
            statusDiv.innerHTML = '<div class="status success">âœ“âœ“ Ã–dÉ™niÅŸ tamamlandÄ± vÉ™ qÉ™bz Ã§ap olundu!<br>3 saniyÉ™ sonra ana sÉ™hifÉ™yÉ™ yÃ¶nlÉ™ndirilirsiniz...</div>';
            
            // 3 saniyÉ™ geri sayÄ±m
            let countdown = 3;
            const countdownInterval = setInterval(() => {
              countdown--;
              if (countdown > 0) {
                statusDiv.innerHTML = `<div class="status success">âœ“âœ“ Ã–dÉ™niÅŸ tamamlandÄ± vÉ™ qÉ™bz Ã§ap olundu!<br>${countdown} saniyÉ™ sonra ana sÉ™hifÉ™yÉ™ yÃ¶nlÉ™ndirilirsiniz...</div>`;
              } else {
                clearInterval(countdownInterval);
                addDebug('Ana sÉ™hifÉ™yÉ™ yÃ¶nlÉ™ndirilir...');
                window.location.href = 'index.html';
              }
            }, 1000);
          } else {
            addDebug(`âš  Ã‡ap xÉ™tasÄ±: ${printResult.error}`);
            statusDiv.innerHTML = '<div class="status error">âš  Ã–dÉ™niÅŸ oldu, lakin qÉ™bz Ã§ap edilmÉ™di!<br>Administratorla É™laqÉ™ saxlayÄ±n.<br>3 saniyÉ™ sonra ana sÉ™hifÉ™yÉ™ yÃ¶nlÉ™ndirilirsiniz...</div>';
            
            // Ã‡ap xÉ™tasÄ± olsa belÉ™ 3 saniyÉ™ sonra ana sÉ™hifÉ™yÉ™ yÃ¶nlÉ™ndir
            setTimeout(() => {
              addDebug('Ana sÉ™hifÉ™yÉ™ yÃ¶nlÉ™ndirilir (Ã§ap xÉ™tasÄ±)');
              window.location.href = 'index.html';
            }, 3000);
          }
        }
      } catch (error) {
        addDebug(`âœ—âœ— XÆTA: ${error.message}`);
        statusDiv.innerHTML = `<div class="status error">âœ— XÉ™ta: ${error.message}<br>ZÉ™hmÉ™t olmasa yenidÉ™n cÉ™hd edin vÉ™ ya administratorla É™laqÉ™ saxlayÄ±n.</div>`;
        btnPay.disabled = false;
      }
    });

    // ============================================
    // 6. GERÄ° DÃœYMÆSI
    // ============================================
    el('btnBack').addEventListener('click', () => {
      addDebug('Geri dÃ¼ymÉ™si basÄ±ldÄ± - Ã¶dÉ™niÅŸ formasÄ± baÄŸlandÄ±');
      
      formPay.style.display = 'none';
      document.querySelectorAll('input[name="credit"]').forEach(r => r.checked = false);
      CURRENT.selected = null;
      el('amount').value = '';
      el('note').value = '';
      el('paymentStatus').innerHTML = '';
      updateSummary();
    });

    // ============================================
    // 7. XÃœLASÆ YENÄ°LÆMÆSÄ°
    // ============================================
    function updateSummary() {
      el('selContract').textContent = CURRENT.selected ? CURRENT.selected.contract : 'â€”';
      el('bankName').textContent = CURRENT.selected ? CURRENT.selected.bank : 'â€”';
      el('namePreview').textContent = CURRENT.customer ? CURRENT.customer.fullName : 'â€”';
      el('due').textContent = CURRENT.selected ? `${CURRENT.selected.due.toFixed(2)} â‚¼` : 'â€”';
    }

    // ============================================
    // 8. SÆHIFÆ YÃœKLÆNDÄ°KDÆ
    // ============================================
    window.addEventListener('DOMContentLoaded', async () => {
      addDebug('========================================');
      addDebug('KREDÄ°T Ã–DÆNÄ°Å KÄ°OSKU BAÅLADI');
      addDebug('========================================');
      addDebug(`Printer URL: ${PRINTER_BASE_URL}`);
      addDebug(`Hardware URL: ${HARDWARE_BASE_URL}`);
      addDebug(`Printer ID: ${PRINTER_ID}`);
      addDebug('----------------------------------------');
      
      // Printer status yoxla
      const printerStatus = await checkPrinterStatus();
      
      if (printerStatus.success) {
        addDebug('âœ“ Sistem hazÄ±rdÄ±r - Ã¶dÉ™niÅŸ qÉ™bul edilÉ™ bilÉ™r');
      } else {
        console.warn('âš  Printer xÉ™tasÄ±:', printerStatus.message);
        addDebug('âš  Printer problemi var - qÉ™bzlÉ™r Ã§ap olunmaya bilÉ™r');
      }
      
      addDebug('========================================');
    });

    // ============================================
    // 9. BÃ–YÃœK TÆQVÄ°M (FLATPICKR)
    // ============================================
    // Not: Flatpickr kitabxanasÄ± sÉ™hifÉ™nin sonunda yÃ¼klÉ™nir
  </script>

  <!-- Flatpickr (TÉ™qvim KitabxanasÄ±) -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    (function() {
      const dobInput = document.getElementById('dob');
      if (!dobInput) return;
      
      try {
        // Input tipini text-É™ Ã§evir (Flatpickr Ã¼Ã§Ã¼n)
        dobInput.setAttribute('type', 'text');
      } catch (e) {
        console.warn('Input tipi dÉ™yiÅŸdirilÉ™ bilmÉ™di:', e);
      }
      
      // Flatpickr tÉ™qvimi aktiv et
      flatpickr(dobInput, {
        dateFormat: "Y-m-d",
        defaultDate: dobInput.value || null,
        allowInput: true,
        disableMobile: false,
        clickOpens: true,
        position: "auto center",
        locale: {
          firstDayOfWeek: 1,
          weekdays: {
            shorthand: ['B', 'Be', 'Ã‡a', 'Ã‡', 'Ca', 'C', 'Å'],
            longhand: ['Bazar', 'Bazar ertÉ™si', 'Ã‡É™rÅŸÉ™nbÉ™ axÅŸamÄ±', 'Ã‡É™rÅŸÉ™nbÉ™', 'CÃ¼mÉ™ axÅŸamÄ±', 'CÃ¼mÉ™', 'ÅÉ™nbÉ™']
          },
          months: {
            shorthand: ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Ä°yn', 'Ä°yl', 'Avq', 'Sen', 'Okt', 'Noy', 'Dek'],
            longhand: ['Yanvar', 'Fevral', 'Mart', 'Aprel', 'May', 'Ä°yun', 'Ä°yul', 'Avqust', 'Sentyabr', 'Oktyabr', 'Noyabr', 'Dekabr']
          }
        }
      });
      
      console.log('âœ“ TÉ™qvim (Flatpickr) aktiv edildi');
    })();
  </script>
</body>
</html>